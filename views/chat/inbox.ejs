

<% layout("layouts/boilerplate") %>

<style>
.inbox-container{
    max-width:1100px;
    margin:auto;
}

/* tabs */
.inbox-tabs{
    display:flex;
    border-bottom:2px solid #eee;
    margin-bottom:20px;
}

.tab-btn{
    padding:12px 18px;
    cursor:pointer;
    font-weight:600;
    color:#777;
    border-bottom:3px solid transparent;
}

.tab-btn.active{
    color:#000;
    border-bottom:3px solid #ff3f6c;
}

/* chat cards */
.chat-card{
    display:flex;
    justify-content:space-between;
    padding:15px;
    border-bottom:1px solid #eee;
    cursor:pointer;
    transition:.2s;
}

.chat-card:hover{
    background:#fafafa;
}

.chat-left{
    display:flex;
    flex-direction:column;
}

.chat-name{
    font-weight:600;
    font-size:16px;
}

.chat-listing{
    font-size:13px;
    color:#666;
}

.chat-last{
    color:#444;
    margin-top:3px;
}

.chat-time{
    font-size:12px;
    color:#888;
}

.unread-dot{
    width:8px;
    height:8px;
    background:#00a884;
    border-radius:50%;
    display:inline-block;
    margin-left:6px;
}

/* mobile */
@media(max-width:600px){
    .chat-card{padding:12px}
    .chat-name{font-size:15px}
}
</style>

<div class="inbox-container">

<h2>Inbox</h2>

<div class="inbox-tabs">
    <div class="tab-btn" id="inquiryTab">Your Inquiries</div>
    <div class="tab-btn" id="listingTab">Your Listings</div>
</div>

<!-- inquries ke liye -->
<div id="inquiriesBox">
<% yourInquiries.forEach(convo=>{ 
const otherUser = convo.participants.find(p=>p._id.toString()!==currUser._id.toString());
%>

<div class="chat-card" data-id="<%= convo._id %>" onclick="openChat('<%= convo._id %>')">

    <div class="chat-left">
        <div class="chat-name">
            <%= otherUser.username %>
            <% if(convo.unread){ %>
                <span class="unread-dot"></span>
            <% } %>
        </div>

        <div class="chat-listing"><%= convo.listing.title %></div>
        <div class="chat-last"><%= convo.lastMessage %></div>
    </div>

    <div class="chat-time">
        <%= formatTime(convo.updatedAt) %>
    </div>
</div>

<% }) %>
</div>


<!-- listings ke liye -->
<div id="listingsBox" style="display:none">
<% yourListings.forEach(convo=>{ 
const otherUser = convo.participants.find(p=>p._id.toString()!==currUser._id.toString());
%>

<div class="chat-card" onclick="openChat('<%= convo._id %>')">
    <div class="chat-left">
        <div class="chat-name">
            <%= otherUser.username %>
            <% if(convo.unread){ %>
                <span class="unread-dot"></span>
            <% } %>
        </div>

        <div class="chat-listing"><%= convo.listing.title %></div>
        <div class="chat-last"><%= convo.lastMessage %></div>
    </div>

    <div class="chat-time">
        <%= formatTime(convo.updatedAt) %>
    </div>
</div>

<% }) %>
</div>

</div>

<script>
const inquiryTab=document.getElementById("inquiryTab");
const listingTab=document.getElementById("listingTab");
const inquiriesBox=document.getElementById("inquiriesBox");
const listingsBox=document.getElementById("listingsBox");

/* default = inquiries */
inquiryTab.classList.add("active");

inquiryTab.onclick=()=>{
    inquiryTab.classList.add("active");
    listingTab.classList.remove("active");
    inquiriesBox.style.display="block";
    listingsBox.style.display="none";
}

listingTab.onclick=()=>{
    listingTab.classList.add("active");
    inquiryTab.classList.remove("active");
    inquiriesBox.style.display="none";
    listingsBox.style.display="block";
}

function openChat(id){
    window.location="/chat/"+id;
}

const socket = io();

// live last message update
socket.on("updateInbox", (data)=>{
    const cards = document.querySelectorAll(".chat-card");

    cards.forEach(card=>{
        if(card.getAttribute("data-id")===data.conversationId){
            card.querySelector(".chat-last").innerText=data.lastMessage;
            card.querySelector(".chat-time").innerText="Just now";

            if(data.sender!== "<%= currUser._id %>"){
                let dot=card.querySelector(".unread-dot");
                if(!dot){
                    const span=document.createElement("span");
                    span.className="unread-dot";
                    card.querySelector(".chat-name").appendChild(span);
                }
            }
        }
    });
});

// remove unread dot when seen
socket.on("updateInboxSeen",(data)=>{
    const card=document.querySelector(`[data-id="${data.conversationId}"]`);
    if(card){
        const dot=card.querySelector(".unread-dot");
        if(dot) dot.remove();
    }
});





socket.emit("joinUserRoom","<%= currUser._id %>");

</script>
                              